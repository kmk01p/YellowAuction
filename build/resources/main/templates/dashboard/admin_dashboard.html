<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <!-- ë°˜ì‘í˜• ë·°í¬íŠ¸ ë©”íƒ€ ì¶”ê°€ -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>ê´€ë¦¬ì í†µí•© ëŒ€ì‹œë³´ë“œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ê³µí†µ ë°˜ì‘í˜• CSS -->
    <link rel="stylesheet" href="/css/responsive.css">
    <style>
        body {
            background-color: #fdfaf1;
            font-family: 'Pretendard', sans-serif;
        }
        .section-box {
            background-color: #ffffff;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.06);
        }
        h2 {
            margin-bottom: 20px;
            font-weight: bold;
        }
        table {
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/">YellowAuction</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="adminNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/">ğŸ  í™ˆìœ¼ë¡œ</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/logout">ğŸ”“ ë¡œê·¸ì•„ì›ƒ</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-12">
            <!-- í”„ë¡œì íŠ¸ í˜„í™© -->
            <div class="section-box">
                <h2>ğŸ“¦ ì „ì²´ ê²½ë§¤ í˜„í™©</h2>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered" id="projectTable">
                        <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>ì œëª©</th>
                            <th>ê²Œì‹œì</th>
                            <th>ìƒíƒœ</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-12">
            <!-- íšŒì› ëª©ë¡ -->
            <div class="section-box">
                <h2>ğŸ‘¥ íšŒì› ëª©ë¡</h2>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered" id="userTable">
                        <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>ì´ë¦„</th>
                            <th>ìœ í˜•</th>
                            <th>ì´ë©”ì¼</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-12">
            <!-- ì…ì°° ëª©ë¡ -->
            <div class="section-box">
                <h2>ğŸ“ˆ ì…ì°° í˜„í™©</h2>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered" id="bidTable">
                        <thead class="table-light">
                        <tr>
                            <th>ì…ì°° ID</th>
                            <th>í”„ë¡œì íŠ¸</th>
                            <th>í”„ë¦¬ëœì„œ</th>
                            <th>ê¸ˆì•¡</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(function () {
        // ê´€ë¦¬ì ì¸ì¦
        $.get("/api/auth/me")
            .done(user => {
                if (user.userType !== 'ADMIN') {
                    alert("ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                    location.href = "/";
                    return;
                }
                loadAdminData();
            })
            .fail(() => {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                location.href = "/login";
            });

        function loadAdminData() {
            // í”„ë¡œì íŠ¸ ëª©ë¡
            $.getJSON("/api/board", res => {
                const tbody = $("#projectTable tbody").empty();
                res.data.forEach(p => {
                    tbody.append(`
            <tr>
              <td>
                <a href="/dashboard/admin_dashboard_detail/${p.id}">
                  ${p.id}
                </a>
              </td>
              <td>${p.title}</td>
              <td>${p.username}</td>
              <td>${p.status}</td>
              <td>
                <button class="btn btn-sm btn-outline-danger me-1"
                        onclick="closeProject(${p.id})">ë§ˆê°</button>
                <button class="btn btn-sm btn-danger"
                        onclick="deleteProject(${p.id})">ì‚­ì œ</button>
              </td>
            </tr>
          `);
                });
            });

            // íšŒì› ëª©ë¡
            $.getJSON("/api/admin/users", res => {
                const tbody = $("#userTable tbody").empty();
                res.forEach(u => {
                    tbody.append(`
            <tr>
              <td>${u.id}</td>
              <td>${u.username}</td>
              <td>${u.userType}</td>
              <td>${u.email || '-'}</td>
            </tr>
          `);
                });
            });

            // ì…ì°° ëª©ë¡
            $.getJSON("/api/admin/bids", res => {
                const tbody = $("#bidTable tbody").empty();
                res.forEach(b => {
                    tbody.append(`
            <tr>
              <td>${b.id}</td>
              <td>${b.boardTitle}</td>
              <td>${b.bidderUsername}</td>
              <td>â‚©${b.amount.toLocaleString()}</td>
            </tr>
          `);
                });
            });
        }

        // í”„ë¡œì íŠ¸ ë§ˆê°
        window.closeProject = function (id) {
            if (!confirm("ì´ í”„ë¡œì íŠ¸ë¥¼ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            $.ajax({
                url: `/api/board/${id}/close`,
                type: "PUT",
                success: loadAdminData,
                error: err => alert("ë§ˆê° ì‹¤íŒ¨: " + err.responseText)
            });
        };

        // í”„ë¡œì íŠ¸ ì‚­ì œ
        window.deleteProject = function (id) {
            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            $.ajax({
                url: `/api/board/${id}`,
                type: "DELETE",
                success: () => {
                    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    loadAdminData();
                },
                error: err => alert("ì‚­ì œ ì‹¤íŒ¨: " + err.responseText)
            });
        };
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
