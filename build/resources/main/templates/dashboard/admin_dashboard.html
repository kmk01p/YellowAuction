<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <!-- 반응형 뷰포트 메타 추가 -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>관리자 통합 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 공통 반응형 CSS -->
    <link rel="stylesheet" href="/css/responsive.css">
    <style>
        body {
            background-color: #fdfaf1;
            font-family: 'Pretendard', sans-serif;
        }
        .section-box {
            background-color: #ffffff;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.06);
        }
        h2 {
            margin-bottom: 20px;
            font-weight: bold;
        }
        table {
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/">YellowAuction</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="adminNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/">🏠 홈으로</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/logout">🔓 로그아웃</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-12">
            <!-- 프로젝트 현황 -->
            <div class="section-box">
                <h2>📦 전체 경매 현황</h2>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered" id="projectTable">
                        <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>제목</th>
                            <th>게시자</th>
                            <th>상태</th>
                            <th>관리</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-12">
            <!-- 회원 목록 -->
            <div class="section-box">
                <h2>👥 회원 목록</h2>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered" id="userTable">
                        <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>이름</th>
                            <th>유형</th>
                            <th>이메일</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-12">
            <!-- 입찰 목록 -->
            <div class="section-box">
                <h2>📈 입찰 현황</h2>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered" id="bidTable">
                        <thead class="table-light">
                        <tr>
                            <th>입찰 ID</th>
                            <th>프로젝트</th>
                            <th>프리랜서</th>
                            <th>금액</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(function () {
        // 관리자 인증
        $.get("/api/auth/me")
            .done(user => {
                if (user.userType !== 'ADMIN') {
                    alert("관리자만 접근할 수 있습니다.");
                    location.href = "/";
                    return;
                }
                loadAdminData();
            })
            .fail(() => {
                alert("로그인이 필요합니다.");
                location.href = "/login";
            });

        function loadAdminData() {
            // 프로젝트 목록
            $.getJSON("/api/board", res => {
                const tbody = $("#projectTable tbody").empty();
                res.data.forEach(p => {
                    tbody.append(`
            <tr>
              <td>
                <a href="/dashboard/admin_dashboard_detail/${p.id}">
                  ${p.id}
                </a>
              </td>
              <td>${p.title}</td>
              <td>${p.username}</td>
              <td>${p.status}</td>
              <td>
                <button class="btn btn-sm btn-outline-danger me-1"
                        onclick="closeProject(${p.id})">마감</button>
                <button class="btn btn-sm btn-danger"
                        onclick="deleteProject(${p.id})">삭제</button>
              </td>
            </tr>
          `);
                });
            });

            // 회원 목록
            $.getJSON("/api/admin/users", res => {
                const tbody = $("#userTable tbody").empty();
                res.forEach(u => {
                    tbody.append(`
            <tr>
              <td>${u.id}</td>
              <td>${u.username}</td>
              <td>${u.userType}</td>
              <td>${u.email || '-'}</td>
            </tr>
          `);
                });
            });

            // 입찰 목록
            $.getJSON("/api/admin/bids", res => {
                const tbody = $("#bidTable tbody").empty();
                res.forEach(b => {
                    tbody.append(`
            <tr>
              <td>${b.id}</td>
              <td>${b.boardTitle}</td>
              <td>${b.bidderUsername}</td>
              <td>₩${b.amount.toLocaleString()}</td>
            </tr>
          `);
                });
            });
        }

        // 프로젝트 마감
        window.closeProject = function (id) {
            if (!confirm("이 프로젝트를 마감하시겠습니까?")) return;
            $.ajax({
                url: `/api/board/${id}/close`,
                type: "PUT",
                success: loadAdminData,
                error: err => alert("마감 실패: " + err.responseText)
            });
        };

        // 프로젝트 삭제
        window.deleteProject = function (id) {
            if (!confirm("정말 삭제하시겠습니까?")) return;
            $.ajax({
                url: `/api/board/${id}`,
                type: "DELETE",
                success: () => {
                    alert("삭제되었습니다.");
                    loadAdminData();
                },
                error: err => alert("삭제 실패: " + err.responseText)
            });
        };
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
