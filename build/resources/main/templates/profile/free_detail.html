<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>프리랜서 프로필 수정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/responsive.css">
    <style>
        body {
            background-color: #fdfaf1;
            font-family: 'Pretendard', sans-serif;
        }
        .main-card {
            max-width: 600px;
            margin: 40px auto;
            padding: 30px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.07);
        }
        .btn-gold {
            background-color: #f9c846;
            border: none;
            color: black;
        }
        .btn-gold:hover {
            background-color: #f6b700;
            color: white;
        }
        /* 기술칩 스타일 */
        .tech-option {
            display: inline-block;
            padding: 6px 12px;
            margin: 4px;
            border: 1px solid #ccc;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .tech-option.selected {
            background-color: #f9c846;
            border-color: #f9c846;
            color: black;
            font-weight: 600;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/">YellowAuction</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navMenu">
            <ul class="navbar-nav">
                <!-- 로그인 상태에 따라 링크 표시 -->
                <li class="nav-item" th:if="${session.loginUser != null}">
                    <a class="nav-link" th:if="${session.loginUser.userType=='EMPLOYER'}"
                       th:href="@{/dashboard/com_dashboard.html}">🏠 홈</a>
                    <a class="nav-link" th:if="${session.loginUser.userType=='FREELANCER'}"
                       th:href="@{/dashboard/free_dashboard.html}">🏠 홈</a>
                </li>
                <li class="nav-item" th:if="${session.loginUser != null}">
                    <a class="nav-link" th:href="@{/profile/free_list.html}">📂 마이페이지</a>
                </li>
                <li class="nav-item" th:if="${session.loginUser != null}">
                    <a class="nav-link" th:href="@{/board/list.html}">📋 경매 목록</a>
                </li>
                <li class="nav-item" th:if="${session.loginUser != null}">
                    <a class="nav-link" th:href="@{/logout}">🔓 로그아웃</a>
                </li>
                <li class="nav-item" th:if="${session.loginUser == null}">
                    <a class="nav-link" th:href="@{/login}">🔑 로그인</a>
                </li>
                <li class="nav-item" th:if="${session.loginUser == null}">
                    <a class="nav-link" th:href="@{/register}">📝 회원가입</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="main-card">
    <h2 class="text-center mb-4">👨‍💻 프리랜서 프로필 수정</h2>
    <input type="hidden" id="profileId">

    <!-- 이름 -->
    <div class="mb-3">
        <label for="name" class="form-label">이름</label>
        <input type="text" id="name" class="form-control" placeholder="이름">
    </div>

    <!-- 희망 직무 -->
    <div class="mb-3">
        <label for="jobType" class="form-label">희망 직무</label>
        <input type="text" id="jobType" class="form-control" placeholder="예: 프론트엔드 개발자">
    </div>

    <!-- 경력 -->
    <div class="mb-3">
        <label for="career" class="form-label">경력(년)</label>
        <input type="number" id="career" class="form-control" placeholder="예: 3">
    </div>

    <!-- 포트폴리오 URL -->
    <div class="mb-3">
        <label for="homepageUrl" class="form-label">포트폴리오 URL</label>
        <input type="url" id="homepageUrl" class="form-control" placeholder="https://">
    </div>

    <!-- 전화번호 -->
    <div class="mb-3">
        <label for="phone" class="form-label">전화번호</label>
        <input type="text" id="phone" class="form-control" placeholder="예: 010-1234-5678">
    </div>

    <!-- 이메일 -->
    <div class="mb-3">
        <label for="email" class="form-label">이메일</label>
        <input type="email" id="email" class="form-control" placeholder="you@example.com">
    </div>

    <!-- 사용 기술 -->
    <div class="col-12">
        <label class="form-label">사용 기술</label>
        <!-- ① 텍스트 입력창 추가 -->
        <input type="text"
               id="techInput"
               class="form-control mb-2"
               placeholder="기술 입력 후 Enter">
        <div id="techOptions" class="border rounded p-3">
            <span class="tech-option">Java</span>
            <span class="tech-option">Javascript</span>
            <span class="tech-option">MySQL</span>
            <span class="tech-option">React</span>
            <span class="tech-option">JPA</span>
            <span class="tech-option">HTML</span>
            <span class="tech-option">CSS</span>
            <span class="tech-option">Git</span>
            <span class="tech-option">SQL</span>
            <span class="tech-option">MyBatis</span>
            <span class="tech-option">TypeScript</span>
            <span class="tech-option">계획성</span>
            <span class="tech-option">공감능력</span>
            <span class="tech-option">고객지향성</span>
        </div>
    </div>

    <!-- 버튼 그룹 -->
    <div class="d-flex justify-content-center gap-2 mt-4">
        <button id="saveBtn" class="btn btn-gold px-4">저장</button>
        <button class="btn btn-outline-secondary px-4"
                onclick="location.href='/profile/free_list.html'">
            목록으로
        </button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(function(){
        // 1) 프로필 ID 추출
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        if(!id) {
            alert('프로필 ID가 없습니다.');
            return;
        }
        $('#profileId').val(id);

        // 2) 프로필 데이터 로드
        function loadProfile(){
            $.getJSON(`/api/profile/${id}`, res => {
                const p = res.data;
                $('#name').val(p.name);
                $('#jobType').val(p.jobType || '');
                $('#career').val(p.career);
                $('#homepageUrl').val(p.homepageUrl || '');
                $('#phone').val(p.phone);
                $('#email').val(p.email);
                // 기존 기술 스택 복원
                p.techStack?.forEach(t => {
                    const chip = $('<span class="tech-option selected"></span>').text(t);
                    $('#techOptions').append(chip);
                });
            })
                .fail(() => {
                    alert('프로필을 불러오지 못했습니다.');
                });
        }

        // 3) 기술칩 클릭 토글
        $('#techOptions').on('click', '.tech-option', function(){
            $(this).toggleClass('selected');
        });

        // 4) Enter 키로 기술칩 추가/토글
        $('#techInput').on('keydown', function(e){
            if(e.key === 'Enter'){
                e.preventDefault();
                const val = $(this).val().trim();
                if(!val) return;
                const exist = $('#techOptions .tech-option').filter((_,el)=>$(el).text()===val);
                if(exist.length) {
                    exist.toggleClass('selected');
                } else {
                    $('<span class="tech-option selected"></span>').text(val).appendTo('#techOptions');
                }
                $(this).val('');
            }
        });

        // 5) 저장 (PUT)
        $('#saveBtn').click(() => {
            const techs = $('#techOptions .tech-option.selected')
                .map((_,el)=>$(el).text()).get();
            const dto = {
                name:        $('#name').val(),
                jobType:     $('#jobType').val(),
                career:      $('#career').val(),
                homepageUrl: $('#homepageUrl').val(),
                phone:       $('#phone').val(),
                email:       $('#email').val(),
                techStack:   techs
            };
            $.ajax({
                url: `/api/profile/${id}`,
                method: 'PUT',
                contentType: 'application/json; charset=UTF-8',
                data: JSON.stringify(dto),
                success(){
                    alert('수정 완료');
                    location.href = '/profile/free_list.html';
                },
                error(xhr){
                    alert('수정 실패: ' + xhr.responseText);
                }
            });
        });

        loadProfile();
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
