<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>프로젝트 목록</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        th { cursor: pointer; }
    </style>
</head>
<body>
<h2>프로젝트 목록</h2>
<button onclick="location.href='/board/create.html'">새 프로젝트 등록</button>
<table border="1" id="projectTable" style="width:100%; margin-top:10px;">
    <thead>
    <tr>
        <th>프로젝트명</th>
        <th class="sortable" data-key="startPrice">초기 경매 금액</th>
        <th class="sortable" data-key="technologies">사용 기술</th>
        <th class="sortable" data-key="status">구인 상태</th>
        <th>Due Day</th>
        <th>구인 기간</th>
        <th>작업</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
    let projects = [], sortAsc = {}, userType = null;

    function loadUserType(callback) {
        $.getJSON('/api/auth/me', function(res) {
            userType = res.userType;  // ✅ 대소문자 그대로 유지 (예: "EMPLOYER", "FREELANCER")
            callback();
        }).fail(() => {
            alert("로그인이 필요합니다.");
            location.href = "/login";
        });
    }

    function loadList() {
        $.getJSON('/api/board', res => {
            projects = res.data;
            renderTable(projects);
        });
    }

    function isExpired(createdAt, period) {
        const created = new Date(createdAt);
        const deadline = new Date(created.getTime() + period * 24 * 60 * 60 * 1000);
        return new Date() > deadline;
    }

    function renderTable(list) {
        const tbody = $('#projectTable tbody').empty();
        list.forEach(p => {
            const expired = isExpired(p.createdAt, p.recruitPeriod);

            const tr = $('<tr>');
            tr.append(`<td><a href="/board/com_detail.html?id=${p.id}">${p.title}</a></td>`);
            tr.append(`<td>${p.startPrice.toLocaleString()}</td>`);
            tr.append(`<td>${p.technologies.join(', ')}</td>`);
            tr.append(`<td>${p.status}</td>`);
            tr.append(`<td>${p.dueDate}</td>`);
            tr.append(`<td>${p.recruitPeriod}일</td>`);

            const actions = $('<td>');
            if (userType === 'FREELANCER') {
                actions.append(`<button ${expired ? 'disabled' : ''} onclick="location.href='/board/free_detail/${p.id}'">입찰</button>`);
                actions.append(`<button disabled>수정</button>`);
            } else if (userType === 'EMPLOYER') {
                actions.append(`<button ${expired ? 'disabled' : ''} onclick="location.href='/board/com_detail/${p.id}'">수정</button>`);
                actions.append(`<button disabled>입찰</button>`);
            } else {
                actions.append(`<button disabled>입찰</button>`);
                actions.append(`<button disabled>수정</button>`);
            }

            tr.append(actions).appendTo(tbody);
        });
    }

    $('.sortable').click(function () {
        const key = $(this).data('key');
        sortAsc[key] = !sortAsc[key];
        const sorted = projects.slice().sort((a, b) => {
            let va = a[key], vb = b[key];
            if (Array.isArray(va)) va = va.join(', ');
            if (Array.isArray(vb)) vb = vb.join(', ');
            return va > vb ? (sortAsc[key] ? 1 : -1) : va < vb ? (sortAsc[key] ? -1 : 1) : 0;
        });
        renderTable(sorted);
    });

    $(document).ready(() => {
        loadUserType(loadList);
    });
</script>
</body>
</html>
