<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>관리자 통합 대시부</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #fdfaf1;
            font-family: 'Pretendard', sans-serif;
        }
        .container {
            margin-top: 60px;
        }
        .section-box {
            background-color: #ffffff;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.06);
        }
        h2 {
            margin-bottom: 20px;
            font-weight: bold;
        }
        table {
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- 프로젝트 현황 -->
    <div class="section-box">
        <h2>📦 전체 경매 현황</h2>
        <table class="table table-striped table-bordered" id="projectTable">
            <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>제목</th>
                <th>의료자</th>
                <th>상태</th>
                <th>관리</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- 유저 목록 -->
    <div class="section-box">
        <h2>👥 회원 목록</h2>
        <table class="table table-striped table-bordered" id="userTable">
            <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>이름</th>
                <th>유형</th>
                <th>이메일</th>
                <th>가입일</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- 입착 목록 -->
    <div class="section-box">
        <h2>📈 입찰 현황</h2>
        <table class="table table-striped table-bordered" id="bidTable">
            <thead class="table-light">
            <tr>
                <th>입착 ID</th>
                <th>프로젝트</th>
                <th>프리랜서</th>
                <th>금액</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(function () {
        $.get("/api/auth/me")
            .done(user => {
                if (user.userType !== 'ADMIN') {
                    alert("가입권한이 없습니다.");
                    location.href = "/";
                    return;
                }
                loadAdminData();
            })
            .fail(() => {
                alert("로그인이 필요합니다.");
                location.href = "/login";
            });

        function loadAdminData() {
            $.getJSON("/api/board", res => {
                const tbody = $("#projectTable tbody").empty();
                res.data.forEach(p => {
                    tbody.append(`
                    <tr>
                        <td>${p.id}</td>
                        <td>${p.title}</td>
                        <td>${p.username}</td>
                        <td>${p.status}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="closeProject(${p.id})">마감</button>
                        </td>
                    </tr>
                `);
                });
            });

            $.getJSON("/api/admin/users", res => {
                const tbody = $("#userTable tbody").empty();
                res.forEach(u => {
                    tbody.append(`
                    <tr>
                        <td>${u.id}</td>
                        <td>${u.username}</td>
                        <td>${u.userType}</td>
                        <td>${u.email || '-'}</td>
                        <td>${u.createdAt || '-'}</td>
                    </tr>
                `);
                });
            });

            $.getJSON("/api/admin/bids", res => {
                const tbody = $("#bidTable tbody").empty();
                res.forEach(b => {
                    tbody.append(`
                    <tr>
                               <td>${b.id}</td>
                              <td>${b.boardTitle}</td>
            <td>${b.bidderUsername}</td>
            <td>${b.amount}</td>
                    </tr>
                `);
                });
            });
        }

        window.closeProject = function (id) {
            if (!confirm("이 프로젝트를 마감하시겠습니까?")) return;
            $.ajax({
                url: `/api/board/${id}/close`,
                type: "PUT",
                success: () => location.reload(),
                error: err => alert("마감 실패: " + err.responseText)
            });
        };
    });
</script>
</body>
</html>